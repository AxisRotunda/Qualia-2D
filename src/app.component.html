<div class="flex flex-col h-screen w-screen bg-[#020617] overflow-hidden text-slate-200 font-sans selection:bg-indigo-500/30">
  
  <!-- Main Viewport Layer (Z-0) -->
  <main class="flex-1 relative bg-black overflow-hidden">
    <app-viewport />

    <!-- Virtual Joypad (Z-30) -->
    <app-virtual-joypad />

    <!-- TELEMETRY PILL (Z-40) -->
    <div class="absolute top-6 left-1/2 -translate-x-1/2 pointer-events-none z-40">
      <app-telemetry />
    </div>

    <!-- COMMAND HUB (Z-50) -->
    <div class="absolute bottom-10 left-1/2 -translate-x-1/2 z-50">
      <div class="flex flex-col items-center gap-3">
        @if (!state.isMainMenuOpen()) {
          <button (click)="toggleSceneBrowser()" class="px-6 py-2 bg-slate-950/60 backdrop-blur-xl border border-white/10 rounded-full text-[9px] font-black text-slate-400 uppercase tracking-widest hover:text-white transition-all active:scale-95 pointer-events-auto">
            Frag: <span class="text-indigo-400">{{ engine.sceneManager.currentScene()?.name || '---' }}</span>
          </button>
        }
        <app-command-hub (create)="toggleCreateMenu()" />
      </div>
    </div>

    <!-- MAIN MENU (Z-90) -->
    @if (state.isMainMenuOpen()) {
      <app-main-menu class="animate-in fade-in zoom-in-95 duration-500" />
    }

    <!-- SELECTION TOOLBAR (Z-60) -->
    <!-- [REPAIR_INPUT_REQ]: Explicitly check for non-null to avoid issues with EntityId 0 -->
    @if (state.selectedEntityId() !== null) {
       @let currentId = state.selectedEntityId()!;
       <div class="absolute bottom-32 left-1/2 -translate-x-1/2 z-60">
          <app-selection-toolbar [entityId]="currentId" />
       </div>
    }

    <!-- SYSTEM LOGS (Z-40) -->
    <div class="absolute top-20 left-6 w-56 pointer-events-none hidden md:block transition-all duration-500 z-40" [class.opacity-20]="state.mode() === 'play'">
      <div class="bg-slate-950/40 backdrop-blur-md rounded-2xl p-4 border border-white/5 space-y-2 pointer-events-auto">
        <div class="space-y-1.5">
          @for (log of commands.commandLog(); track $index) {
            <div class="text-[10px] font-mono text-slate-400 truncate animate-in fade-in slide-in-from-left-2 duration-300">
              <span class="text-indigo-500/50 mr-1">â€º</span>{{ log }}
            </div>
          }
        </div>
      </div>
    </div>

    <!-- OVERLAYS -->
    @if (state.isSceneBrowserOpen()) {
      <app-scene-browser-overlay (select)="loadScene($event)" (close)="toggleSceneBrowser()" />
    }

    @if (state.isCreateMenuOpen()) {
      <app-create-menu-overlay (spawn)="spawnEntity($event)" (close)="toggleCreateMenu()" />
    }

    <!-- BOOT LOADER (Z-100) -->
    @if (state.loading()) {
      <div class="absolute inset-0 flex items-center justify-center bg-[#020617] z-[100] transition-all">
        <div class="flex flex-col items-center gap-8 animate-in fade-in duration-700">
          <div class="relative">
            <div class="w-24 h-24 border-2 border-indigo-500/10 rounded-full"></div>
            <div class="absolute inset-0 border-t-2 border-indigo-500 rounded-full animate-spin"></div>
          </div>
          <div class="flex flex-col items-center gap-2">
            <h1 class="text-white font-black tracking-[0.4em] text-2xl">QUALIA_2D</h1>
            <p class="text-[9px] text-indigo-500/50 font-black uppercase tracking-[0.5em]">Syncing Fragments</p>
          </div>
        </div>
      </div>
    }
  </main>

  <!-- HIERARCHY DRAWER (LEFT) -->
  <app-panel-drawer 
    side="left" 
    title="Hierarchy" 
    [visible]="state.activePanel() === 'hierarchy'"
    (close)="state.setActivePanel('none')">
    <app-hierarchy />
  </app-panel-drawer>

  <!-- INSPECTOR / SETTINGS DRAWER (RIGHT) -->
  <app-panel-drawer 
    side="right" 
    [title]="state.activePanel() === 'settings' ? 'Engine' : 'Properties'" 
    [visible]="state.activePanel() === 'inspector' || state.activePanel() === 'settings'"
    (close)="state.setActivePanel('none')">
    @if (state.activePanel() === 'inspector') {
      <app-inspector />
    } @else if (state.activePanel() === 'settings') {
      <app-engine-settings />
    }
  </app-panel-drawer>
</div>