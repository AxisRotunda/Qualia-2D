
<div class="flex flex-col h-screen w-screen bg-slate-950 overflow-hidden select-none text-slate-200">
  <!-- Toolbar -->
  <header class="h-14 bg-slate-900 border-b border-slate-800 flex items-center px-3 justify-between z-20 shadow-lg">
    <div class="flex items-center gap-2 sm:gap-4">
      <h1 class="font-black text-amber-500 tracking-tighter text-lg">Q2D</h1>
      
      <div class="h-6 w-px bg-slate-700 mx-1 hidden sm:block"></div>
      
      <div class="flex items-center gap-1">
        <button 
          (click)="engine.togglePlay()"
          class="px-3 py-1.5 rounded-md text-[10px] font-bold transition-all flex items-center gap-1 active:scale-95"
          [class.bg-green-500]="state.mode() === 'play'"
          [class.text-black]="state.mode() === 'play'"
          [class.bg-slate-800]="state.mode() !== 'play'"
          [class.hover:bg-slate-700]="state.mode() !== 'play'">
          @if (state.mode() === 'play') { 
            <span class="w-2 h-2 rounded-full bg-black animate-pulse"></span> STOP 
          } @else { 
            PLAY 
          }
        </button>

        <button (click)="engine.resetScene()" class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded-md text-[10px] font-bold active:scale-95">
          RESET
        </button>

        <button (click)="engine.spawnBox()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-md text-[10px] font-bold active:scale-95 shadow-md shadow-blue-900/20">
          + BOX
        </button>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <div class="hidden lg:flex items-center gap-4 text-[10px] font-mono text-slate-500">
        <span class="bg-slate-800 px-2 py-1 rounded">FPS: {{ state.fps() | number:'1.0-0' }}</span>
        <span class="bg-slate-800 px-2 py-1 rounded">CAM: {{ state.cameraX() | number:'1.1-1' }}, {{ state.cameraY() | number:'1.1-1' }}</span>
      </div>

      <button 
        (click)="state.toggleInspector()"
        class="p-2 rounded-md transition-colors lg:hidden"
        [class.bg-amber-500]="state.showInspector()"
        [class.text-black]="state.showInspector()"
        [class.bg-slate-800]="!state.showInspector()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zm0 13A6 6 0 1 1 8 2a6 6 0 0 1 0 12z"/>
          <path d="M7 8a1 1 0 1 1 2 0 1 1 0 0 1-2 0z"/>
        </svg>
      </button>
    </div>
  </header>

  <div class="flex-1 flex overflow-hidden relative">
    <!-- Main Viewport -->
    <main class="flex-1 relative bg-black cursor-crosshair touch-none">
      <canvas #mainCanvas 
        class="block w-full h-full"
        (wheel)="onWheel($event)"
        (mousedown)="onMouseDown($event)"
        (mousemove)="onMouseMove($event)"
        (mouseup)="onMouseUp()"
        (touchstart)="onTouchStart($event)"
        (touchmove)="onTouchMove($event)"
        (touchend)="onTouchEnd()"
        (contextmenu)="$event.preventDefault()">
      </canvas>

      <!-- Overlay Stats (Mobile Only) -->
      <div class="absolute bottom-4 left-4 flex gap-2 lg:hidden pointer-events-none">
        <div class="px-2 py-1 bg-black/60 backdrop-blur-md rounded text-[9px] font-mono border border-white/10">
          FPS: {{ state.fps() | number:'1.0-0' }}
        </div>
        <div class="px-2 py-1 bg-black/60 backdrop-blur-md rounded text-[9px] font-mono border border-white/10">
          ENT: {{ engine['ecs'].entityCount() }}
        </div>
      </div>

      <!-- Engine Loading Overlay -->
      @if (state.loading()) {
        <div class="absolute inset-0 flex items-center justify-center bg-slate-950/90 z-50">
          <div class="flex flex-col items-center gap-3">
            <div class="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
            <div class="text-amber-500 font-mono text-xs tracking-widest animate-pulse">QUALIA2D_BOOT_SEQ</div>
          </div>
        </div>
      }
    </main>

    <!-- Inspector Panel (Desktop Sidebar / Mobile Bottom Sheet) -->
    <aside 
      class="fixed inset-x-0 bottom-0 z-30 transform transition-transform duration-300 ease-out lg:relative lg:translate-y-0 lg:w-72 lg:inset-auto lg:border-l border-slate-800 bg-slate-900/95 backdrop-blur-xl shadow-2xl lg:shadow-none flex flex-col"
      [class.translate-y-0]="state.showInspector()"
      [class.translate-y-full]="!state.showInspector()">
      
      <!-- Drag Handle for Mobile -->
      <div (click)="state.toggleInspector()" class="h-1.5 w-12 bg-slate-700 rounded-full mx-auto my-3 lg:hidden cursor-pointer"></div>

      <div class="flex-1 flex flex-col p-4 overflow-y-auto max-h-[70vh] lg:max-h-none">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-slate-400 font-bold text-[10px] uppercase tracking-[0.2em]">Inspector</h2>
            <div class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-500 font-mono">
              ENT_COUNT: {{ engine['ecs'].entityCount() }}
            </div>
        </div>
        
        @if (state.selectedEntityId(); as id) {
          <div class="space-y-4">
             <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
               <label class="block text-slate-500 text-[9px] mb-1 uppercase font-bold tracking-wider">Entity ID</label>
               <div class="text-amber-400 font-mono text-lg">#{{ id }}</div>
             </div>

             @if (engine['ecs'].getTransform(id); as t) {
               <div class="p-3 bg-slate-950/50 rounded-lg border border-slate-800">
                  <div class="flex items-center gap-2 mb-3">
                    <div class="w-1.5 h-4 bg-amber-500 rounded-full"></div>
                    <div class="text-white text-xs font-bold uppercase tracking-tight">Transform</div>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-3 mb-3">
                      <div class="bg-slate-900 p-2 rounded border border-white/5">
                          <div class="text-[8px] text-slate-600 mb-0.5 font-bold uppercase">X Position</div>
                          <div class="text-xs font-mono text-white">{{ t.x | number:'1.3-3' }}</div>
                      </div>
                      <div class="bg-slate-900 p-2 rounded border border-white/5">
                          <div class="text-[8px] text-slate-600 mb-0.5 font-bold uppercase">Y Position</div>
                          <div class="text-xs font-mono text-white">{{ t.y | number:'1.3-3' }}</div>
                      </div>
                  </div>
                  
                  <div class="bg-slate-900 p-2 rounded border border-white/5">
                     <div class="text-[8px] text-slate-600 mb-0.5 font-bold uppercase">Rotation</div>
                     <div class="text-xs font-mono text-white">{{ t.rotation | number:'1.2-2' }} <span class="text-[9px] text-slate-500 ml-1">rad</span></div>
                  </div>
               </div>
             }

             @if (engine['ecs'].getSprite(id); as s) {
               <div class="p-3 bg-slate-950/50 rounded-lg border border-slate-800">
                  <div class="flex items-center gap-2 mb-3">
                    <div class="w-1.5 h-4 bg-blue-500 rounded-full"></div>
                    <div class="text-white text-xs font-bold uppercase tracking-tight">Sprite</div>
                  </div>
                  
                  <div class="flex items-center justify-between bg-slate-900 p-2 rounded border border-white/5">
                      <div class="flex items-center gap-3">
                        <div class="w-6 h-6 rounded border border-white/10 shadow-inner" [style.background-color]="s.color"></div>
                        <span class="text-[10px] font-mono uppercase text-slate-300">{{ s.color }}</span>
                      </div>
                      <div class="text-[8px] text-slate-500 font-bold bg-slate-800 px-1.5 py-0.5 rounded">LAYER: {{ s.layer }}</div>
                  </div>
               </div>
             }
             
             <button (click)="engine.state.selectedEntityId.set(null)" class="w-full py-2 bg-slate-800 hover:bg-red-900/40 text-slate-400 hover:text-red-400 rounded-md text-[10px] font-bold transition-colors uppercase tracking-widest border border-slate-700">
               Deselect
             </button>
          </div>
        } @else {
          <div class="flex-1 flex flex-col items-center justify-center text-slate-600 py-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mb-4 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
            </svg>
            <div class="italic text-[10px] tracking-wide uppercase">Select an entity in the viewport</div>
          </div>
        }
      </div>
    </aside>
  </div>
</div>
